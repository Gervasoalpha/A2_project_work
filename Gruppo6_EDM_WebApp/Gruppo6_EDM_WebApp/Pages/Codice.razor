@page "/codice"
@using System.Text.Json;
@inject ILocalStorageService localStorage

<h3>Codice</h3>

@if (string.IsNullOrEmpty(unlockCode))
{
    <div class="center">
        <input type="text" @bind="authCode" placeholder="Inserisci l'authcode" />
        <button type="button" class="btn btn-primary" @onclick="FetchUnlockCode">Invia richiesta</button>
    </div>
}
@if (!string.IsNullOrEmpty(unlockCodeMessage))
{
    <div class="center">
        @unlockCodeMessage
    </div>
}

@code {
    private string authCode;
    private string unlockCode;
    private string unlockCodeMessage;

    [Inject]
    private HttpClient HttpClient { get; set; }

    [Inject]
    private AuthenticationStateProvider AuthenticationStateProvider { get; set; }

    private async Task FetchUnlockCode()
    {
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authenticationState.User;

        if (user.Identity.IsAuthenticated)
        {

            string authToken = await localStorage.GetItemAsync<string>("authToken");

            if (!string.IsNullOrEmpty(authToken))
            {
                HttpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authToken);

                var response = await HttpClient.GetAsync("https://gruppo6-webapp.azurewebsites.net/api/Logs/unlock/" + authCode);

                if (response.IsSuccessStatusCode)
                {
                    unlockCode = await response.Content.ReadAsStringAsync();
                    unlockCodeMessage = "Codice di sblocco: " + unlockCode;
                    //var body = JsonSerializer.Serialize($"'authcode':{authCode}, 'username':{user}");
                    //await HttpClient.PutAsync("https://gruppo6-webapp.azurewebsites.net/api/Logs/updateusername", body);
                }
                else
                {
                    unlockCodeMessage = "Codice inserito sbagliato o scaduto";
                }
            }
        }
    }
}
